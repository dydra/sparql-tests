#! /bin/sh

# run all visible test suites.
# start either relative to this script file or at the given root.

if [ "$DYDRA_ACCOUNT" = "" ]
then
  echo "no value present for DYDRA_ACCOUNT"
  exit 
fi

if [ "$1" != "" ]
then
  ROOT="$1"
else
  ROOT=.
fi

# count externally to cope with shell's incapacity
cat /dev/null > tests-failed
cat /dev/null > tests-succeeded

# for each query.rq present, run a test in the respective directory
find $ROOT -name '*.rq' | while read QUERY; do
 DIR=`dirname $QUERY`
 TEST=`basename $DIR`
 QUERY_FILENAME=`basename $QUERY`
 QUERY_REPOSITORY=${QUERY_FILENAME%.*}

 if [ "$DYDRA_VERBOSE" != "" ]
 then
   echo -n "$TEST ... "
 fi

 # for each test, take each rdf file as the initial repository content
 # and set up the respective dataset
 find $DIR -name '*.nq' -or -name '*.nt' -or -name '*.rdf' -or -name '*.ttl' | while read INPUT; do setup-repository $INPUT; done;

 # then either run a specific test script or run the query
 if [ -e $DIR/run.sh ]
 then
   (cd $DIR; sh run.sh | sort > result.srj; diff result.srj expected.srj)
 else
   # (cd $DIR; roqet -h "http://${DYDRA_TOKEN}:@${DYDRA_URL:7}/$DYDRA_ACCOUNT/${QUERY_REPOSITORY}/sparql" -s $QUERY_FILENAME | sort > result.srj; diff result.srj expected.srj)
   (cd $DIR; run-query $DYDRA_ACCOUNT/$QUERY_REPOSITORY $QUERY_FILENAME | sort > result.srj;
     if [ -e expected.srj ]
     then
       cmp -s result.srj expected.srj
     else
       mv result.srj expected.srj
     fi )
 fi

 if [ $? != 0 ]
 then
   echo $DIR >> tests-failed
   if [ "$DYDRA_VERBOSE" == "" ]
   then
     echo -n "-"
   else
     echo "$TEST failed"
   fi
 else
   echo $DIR >> tests-succeeded
   if [ "$DYDRA_VERBOSE" == "" ]
   then
     echo -n "+"
   else
     echo "$TEST succeeded"
   fi
 fi

done

FAILED=(`wc -l tests-failed`)
SUCCEEDED=(`wc -l tests-succeeded`)
echo "succeeded ${SUCCEEDED[0]}, failed ${FAILED[0]}"
exit $FAIL 
